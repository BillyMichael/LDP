gitea:
  ingress:
    enabled: true
    annotations:
      traefik.ingress.kubernetes.io/router.entrypoints: websecure
      cert-manager.io/cluster-issuer: ca-issuer
    hosts:
      - host: vcs-127-0-0-1.nip.io
    tls:
      - secretName: gitea-server-tls
        hosts:
          - vcs-127-0-0-1.nip.io

  service:
    DISABLE_REGISTRATION: true

  oauth2_client:
    ENABLE_AUTO_REGISTRATION: true

  gitea:
    oauth:
      - name: "Authelia"
        provider: "openidConnect"
        key: "gitea"
        secret: "insecure_secret"
        autoDiscoverUrl: "https://auth-127-0-0-1.nip.io/.well-known/openid-configuration"
        scopes:
          - "openid"
          - "profile"
          - "email"
          - "groups"

  valkey-cluster:
    enabled: false
  valkey:
    enabled: true

  postgresql-ha:
    enabled: false
  postgresql:
    enabled: true

  # Mount CA certificate into container
  extraVolumes:
    - name: ca
      configMap:
        name: ca
        defaultMode: 420

  extraVolumeMounts:
    - name: ca
      mountPath: /usr/local/share/ca-certificates/ldp-ca.pem
      subPath: trust-bundle.pem
      readOnly: true

  # Add init container to update CA certificates
  extraInitContainers:
    - name: update-ca-certificates
      image: gitea/gitea:1.21.5  # Use same image as main container
      command:
        - sh
        - -c
        - |
          cp /usr/local/share/ca-certificates/ldp-ca.pem /tmp-certs/ldp-ca.pem
          update-ca-certificates
          cp -r /etc/ssl/certs/* /shared-certs/
      volumeMounts:
        - name: ca
          mountPath: /usr/local/share/ca-certificates/ldp-ca.pem
          subPath: trust-bundle.pem
          readOnly: true
        - name: shared-certs
          mountPath: /shared-certs
        - name: tmp-certs
          mountPath: /tmp-certs

  extraVolumes:
    - name: ca
      configMap:
        name: ca
        defaultMode: 420
    - name: shared-certs
      emptyDir: {}
    - name: tmp-certs
      emptyDir: {}

  extraVolumeMounts:
    - name: shared-certs
      mountPath: /etc/ssl/certs
      readOnly: true